<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chip Factory - Learn How Computer Chips Are Made!</title>
    <style>
        :root {
            color-scheme: light;
            --bg: #f4f6fb;
            --surface: #ffffff;
            --surface-muted: #eef2fb;
            --text: #1f2937;
            --text-subtle: #5b6678;
            --accent: #2f80ed;
            --accent-soft: rgba(47, 128, 237, 0.12);
            --success: #2fb383;
            --border: #d6deeb;
            --shadow: 0 18px 40px rgba(18, 33, 71, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        a {
            color: inherit;
        }

        #main-container {
            max-width: 1120px;
            margin: 16px auto 28px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        h1 {
            font-size: clamp(28px, 4vw, 40px);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .tagline {
            font-size: 17px;
            color: var(--text-subtle);
            max-width: 620px;
            line-height: 1.5;
        }

        #info-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .start-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 14px 26px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
            box-shadow: 0 12px 22px rgba(47, 128, 237, 0.18);
        }

        button:hover,
        button:focus-visible {
            background: #226ad6;
            transform: translateY(-1px);
            outline: none;
        }

        .secondary {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
            box-shadow: none;
        }

        .info-card button {
            width: 100%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            flex-wrap: nowrap;
        }

        canvas {
            border-radius: 16px;
        }

        #gameCanvas {
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-width: 320px;
            box-shadow: 0 20px 38px rgba(15, 23, 42, 0.35);
            flex: none;
        }

        #info-panel {
            width: 420px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
        }

        h2 {
            margin: 0 0 12px;
            font-size: 22px;
        }

        h3 {
            margin: 0 0 12px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-subtle);
        }

        .info-card {
            background: var(--surface-muted);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(214, 222, 235, 0.7);
        }

        .device-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .device-card {
            border-radius: 12px;
            border: 1px solid transparent;
            padding: 14px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-start;
            transition: border-color 0.2s ease, background 0.2s ease, transform 0.15s ease;
            cursor: pointer;
        }

        .device-card:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
            transform: translateY(-1px);
        }

        .device-card.active {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .device-name {
            font-weight: 600;
            font-size: 16px;
        }

        .device-simple {
            font-size: 13px;
            color: var(--text-subtle);
        }

        .score-display {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .score-item {
            background: #fff;
            border-radius: 10px;
            border: 1px solid rgba(214, 222, 235, 0.7);
            padding: 12px;
        }

        .score-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
        }

        .score-label {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-subtle);
        }

        .progress-bar {
            height: 12px;
            background: rgba(47, 128, 237, 0.1);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #4bd2cf);
            width: 0;
            border-radius: 999px;
            transition: width 0.4s ease;
        }

        #progress-text {
            margin-left: 8px;
            font-size: 13px;
            color: var(--text-subtle);
        }

        #blueprint-canvas {
            width: 100%;
            max-width: 340px;
            border-radius: 12px;
            border: 1px solid rgba(214, 222, 235, 0.7);
            background: #f7f9ff;
        }

        .layer-copy {
            margin-top: 12px;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-subtle);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
            color: var(--text-subtle);
        }

        .control-key {
            background: rgba(47, 128, 237, 0.16);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
        }

        .fact-box {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px;
            border-radius: 10px;
            border: 1px dashed rgba(47, 128, 237, 0.35);
            background: rgba(47, 128, 237, 0.08);
            color: var(--text);
            font-size: 13px;
        }

        .fact-title {
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(240px, auto);
            gap: 16px;
            align-items: start;
        }

        .info-left {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .info-right {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .action-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #tutorial-message {
            background: rgba(47, 128, 237, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: var(--text);
            border: 1px solid rgba(47, 128, 237, 0.35);
        }

        #bonus-indicator {
            position: fixed;
            top: 16%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            font-size: clamp(36px, 6vw, 56px);
            font-weight: 700;
            color: var(--success);
            opacity: 0;
            pointer-events: none;
        }

        .bonus-active {
            animation: bonusPop 1.2s ease-out;
        }

        @keyframes bonusPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @media (max-width: 960px) {
            #game-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            #info-panel {
                width: 100%;
                max-height: none;
            }

            #blueprint-canvas {
                max-width: 100%;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 30, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--surface);
            border-radius: 18px;
            border: 1px solid rgba(214, 222, 235, 0.7);
            width: min(90%, 500px);
            padding: 28px;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .modal-content ol {
            margin: 0 0 6px 18px;
            color: var(--text-subtle);
            line-height: 1.5;
        }

        .modal-content p {
            margin: 0;
            color: var(--text-subtle);
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .modal-actions button {
            flex: 1;
            min-width: 140px;
        }

        .hidden {
            display: none;
        }

        .close-modal {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            color: var(--text-subtle);
            padding: 4px;
            border-radius: 50%;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <header>
            <div>
                <h1>üè≠ Chip Factory</h1>
                <p class="tagline">
                    Stack layers, unlock fun facts, and watch real chip components take shape in minutes.
                </p>
            </div>
            <button class="secondary" id="open-instructions">How it works</button>
        </header>

        <section id="game-container">
            <canvas id="gameCanvas" width="300" height="600"></canvas>

            <aside id="info-panel">
                <div>
                    <h2>Stay On Track</h2>
                    <div id="tutorial-message" style="display: none;">
                        <strong>Guided Tour</strong>
                        <p id="tutorial-text" style="margin: 6px 0 0;"></p>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-left">
                        <div class="info-card">
                            <h3>Choose Your Device</h3>
                            <div class="device-selector">
                                <div class="device-card active" onclick="selectDevice('transistor', event)">
                                    <div class="device-name">Transistor</div>
                                    <div class="device-simple">The On/Off Switch</div>
                                </div>
                                <div class="device-card" onclick="selectDevice('diode', event)">
                                    <div class="device-name">Diode</div>
                                    <div class="device-simple">One-Way Valve</div>
                                </div>
                                <div class="device-card" onclick="selectDevice('capacitor', event)">
                                    <div class="device-name">Capacitor</div>
                                    <div class="device-simple">Energy Storage</div>
                                </div>
                            </div>
                        </div>

                        <div class="info-card">
                            <h3>Progress</h3>
                            <div class="score-display">
                                <div class="score-item">
                                    <span class="score-value" id="score">0</span>
                                    <span class="score-label">Points</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-value" id="devices">0</span>
                                    <span class="score-label">Chips Built</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress"></div>
                            </div>
                            <span id="progress-text">0%</span>
                        </div>

                        <div class="info-card controls">
                            <h3>Controls</h3>
                            <div><span class="control-key">‚Üê</span> / <span class="control-key">‚Üí</span> Move</div>
                            <div><span class="control-key">‚Üì</span> Soft drop</div>
                            <div><span class="control-key">Space</span> Snap into place</div>
                            <div><span class="control-key">P</span> Pause</div>
                        </div>

                        <div class="info-card action-card">
                            <button onclick="restartGame()">Start Over</button>
                            <div class="fact-box">
                                <span class="fact-title">Did you know?</span>
                                <span id="fact-text">
                                    A modern computer chip can contain over 50 billion transistors‚Äîmore than six times the world's population.
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="info-right">
                        <div class="info-card">
                            <h3>Blueprint</h3>
                            <canvas id="blueprint-canvas" width="360" height="200"></canvas>
                            <div class="layer-copy">
                                <strong>Current Step:</strong>
                                <span id="current-layer">Foundation</span><br />
                                <span id="layer-description">The base layer of our chip</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </section>
    </div>

    <div id="bonus-indicator"></div>

    <div id="instructions-modal" class="modal hidden">
        <div class="modal-content">
            <button class="close-modal" id="close-instructions" aria-label="Close instructions">√ó</button>
            <h2>How Chip Factory Works</h2>
            <p>
                Move each falling layer so it lines up with the highlighted blueprint on the right.
                When everything stacks correctly, you build a real-world component used inside chips.
            </p>
            <ol>
                <li>Pick a device (transistor, diode, capacitor) to see its recipe.</li>
                <li>Match layers to the blueprint. Perfect placement glows green and earns bonus points.</li>
                <li>Finish every layer to ship the device, unlock fun facts, and start again.</li>
            </ol>
            <div class="modal-actions">
                <button id="start-guided" class="secondary">Play with guidance</button>
                <button id="resume-play">Back to game</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const blueprintCanvas = document.getElementById("blueprint-canvas");
        const bpCtx = blueprintCanvas.getContext("2d");

        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;

        let tutorialMode = false;
        let tutorialStep = 0;

        const DEVICES = {
            transistor: {
                name: "Transistor",
                simple: "The On/Off Switch",
                description:
                    "Like a light switch for electricity‚Äîthe basic building block of all computer chips!",
                width: 5,
                height: 6,
                layers: [
                    {
                        name: "Foundation",
                        simple: "Silicon Base",
                        description: "Pure silicon crystal‚Äîlike the concrete slab in a home build. It gives every other layer a level base to rest on.",
                        color: "#6B7280",
                        pattern: [
                            [1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1],
                        ],
                    },
                    {
                        name: "Electrical Zones",
                        simple: "Conductive Areas",
                        description: "Special regions that let electricity flow, similar to wiring copper paths through a wall. They direct traffic so electrons know where to go.",
                        color: "#F2B705",
                        pattern: [
                            [1, 0, 0, 0, 1],
                            [1, 0, 0, 0, 1],
                        ],
                    },
                    {
                        name: "Insulator",
                        simple: "Electric Barrier",
                        description: "A super-thin glass layer that blocks electricity, like the insulation in a windowpane. It keeps the energy separated until we need it.",
                        color: "#60A5FA",
                        pattern: [[0, 1, 1, 1, 0]],
                    },
                    {
                        name: "Gate",
                        simple: "Control Switch",
                        description: 'The "handle" that turns the transistor on or off‚Äîpicture a faucet lever that opens or closes water flow.',
                        color: "#F87171",
                        pattern: [[0, 1, 1, 1, 0]],
                    },
                    {
                        name: "Connectors",
                        simple: "Metal Wires",
                        description: "Metal connections to the rest of the chip, just like the prongs on a power plug. They carry signals out to the wider circuit.",
                        color: "#E5E7EB",
                        pattern: [[1, 0, 1, 0, 1]],
                    },
                    {
                        name: "Protection",
                        simple: "Protective Coating",
                        description: "Final protective layer‚Äîlike the clear coat on a phone screen protector. It shields the delicate parts from dust and scratches.",
                        color: "#34D399",
                        pattern: [[1, 1, 1, 1, 1]],
                    },
                ],
            },
            diode: {
                name: "Diode",
                simple: "One-Way Valve",
                description:
                    "Like a one-way door for electricity‚Äîonly lets current flow in one direction!",
                width: 3,
                height: 5,
                layers: [
                    {
                        name: "P-Type Silicon",
                        simple: "Positive Side",
                        description: 'Silicon filled with "holes" that attract electrons, similar to a sponge ready to soak up water.',
                        color: "#C084FC",
                        pattern: [
                            [1, 1, 1],
                            [1, 1, 1],
                        ],
                    },
                    {
                        name: "N-Type Silicon",
                        simple: "Negative Side",
                        description: "Silicon with extra electrons, like a battery pack stocked with extra charge.",
                        color: "#FCD34D",
                        pattern: [
                            [1, 1, 1],
                            [1, 1, 1],
                        ],
                    },
                    {
                        name: "Positive Terminal",
                        simple: "Plus Connection",
                        description: "Where positive voltage connects‚Äîthink of it as the red terminal on a car battery.",
                        color: "#E5E7EB",
                        pattern: [[0, 1, 0]],
                    },
                    {
                        name: "Negative Terminal",
                        simple: "Minus Connection",
                        description: "Where negative voltage connects, just like the black terminal on a car battery.",
                        color: "#D1D5DB",
                        pattern: [[0, 1, 0]],
                    },
                    {
                        name: "Protection",
                        simple: "Protective Coating",
                        description: "Seals and protects the device, acting like the plastic shell around a phone charger.",
                        color: "#34D399",
                        pattern: [[1, 1, 1]],
                    },
                ],
            },
            capacitor: {
                name: "Capacitor",
                simple: "Energy Storage",
                description:
                    "Like a tiny rechargeable battery‚Äîstores electrical energy for later use!",
                width: 4,
                height: 5,
                layers: [
                    {
                        name: "Bottom Plate",
                        simple: "First Metal Layer",
                        description: "First metal plate‚Äîlike the bottom slice of bread in a sandwich. It forms one side of the energy storage pocket.",
                        color: "#9CA3AF",
                        pattern: [
                            [1, 1, 1, 1],
                            [1, 1, 1, 1],
                        ],
                    },
                    {
                        name: "Insulator",
                        simple: "Electric Separator",
                        description: "Keeps the plates apart but lets energy build up, similar to the air gap in a thermos wall that keeps heat in.",
                        color: "#60A5FA",
                        pattern: [[1, 1, 1, 1]],
                    },
                    {
                        name: "Top Plate",
                        simple: "Second Metal Layer",
                        description: "Second metal plate‚Äîcompletes the sandwich, like placing the bread on top to finish a grilled cheese.",
                        color: "#E5E7EB",
                        pattern: [
                            [1, 1, 1, 1],
                            [1, 1, 1, 1],
                        ],
                    },
                    {
                        name: "Connections",
                        simple: "Wire Attachments",
                        description: "Where we connect wires to use the stored energy‚Äîthe equivalent of attaching jumper cables to a battery.",
                        color: "#FCD34D",
                        pattern: [[1, 0, 0, 1]],
                    },
                    {
                        name: "Protection",
                        simple: "Protective Coating",
                        description: "Keeps everything safe and secure, like the clear lacquer on a wooden table.",
                        color: "#34D399",
                        pattern: [[1, 1, 1, 1]],
                    },
                ],
            },
        };

        const FUN_FACTS = [
            "A modern computer chip can contain over 50 billion transistors‚Äîthat's more than six times the world's population.",
            "The first transistor was as big as your palm. Now millions fit on your fingernail.",
            "Chip factories are 1,000 times cleaner than hospital operating rooms.",
            "Computer chips start with sand‚Äîsilicon is refined from quartz to build every layer.",
            "A single dust particle can ruin a chip, which is why clean-room suits look like spacesuits.",
            "Modern chips have wires just 5 nanometers wide‚Äî10,000 times thinner than a human hair.",
            "It takes roughly three months of layered steps to manufacture a single computer chip.",
            "Taiwan produces over 60% of the world's semiconductors‚Äîthey are the planet's chip hub.",
            "Your smartphone has more computing power than all of NASA had during the Apollo missions.",
            "Chipmaking uses some of the purest water on Earth‚Äîcleaner than bottled water.",
        ];

        const TUTORIAL_MESSAGES = [
            "Welcome! Each falling layer is part of a real chip-building recipe.",
            "Match the layout on the right‚Äîthe yellow guide shows where this layer belongs.",
            "Use the arrow keys to slide the layer into position.",
            "Perfect alignment glows green. Nail it for bonus points!",
            "Every layer adds a new function‚Äîyou're literally sculpting a component.",
            "Complete the stack to ship a finished device and earn a score boost.",
            "You're now ready to experiment. Try the other devices when you're confident!",
        ];

        let board = [];
        let currentDevice = "transistor";
        let currentLayerIndex = 0;
        let currentPiece = null;
        let score = 0;
        let devicesBuilt = 0;
        let isPaused = false;
        let dropCounter = 0;
        let lastTime = 0;
        let deviceStartX = 3;
        let deviceStartY = 14;
        let currentFactIndex = 0;
        let gameLoopStarted = false;
        let instructionsOpen = false;
        let wasPausedBeforeModal = false;
        const instructionsModal = document.getElementById("instructions-modal");
        const openInstructionsBtn = document.getElementById("open-instructions");
        const closeInstructionsBtn = document.getElementById("close-instructions");
        const resumePlayBtn = document.getElementById("resume-play");
        const startGuidedBtn = document.getElementById("start-guided");

        class Piece {
            constructor() {
                const device = DEVICES[currentDevice];
                const layer = device.layers[currentLayerIndex];
                this.pattern = layer.pattern;
                this.color = layer.color;
                this.name = layer.simple;
                this.x = deviceStartX;
                this.y = 0;
                this.targetY = deviceStartY + this.getLayerOffset();
            }

            getLayerOffset() {
                const device = DEVICES[currentDevice];
                let offset = 0;
                for (let i = 0; i < currentLayerIndex; i++) {
                    offset += device.layers[i].pattern.length;
                }
                return offset;
            }

            collides() {
                for (let row = 0; row < this.pattern.length; row++) {
                    for (let col = 0; col < this.pattern[row].length; col++) {
                        if (this.pattern[row][col]) {
                            const boardX = this.x + col;
                            const boardY = this.y + row;

                            if (boardX < 0 || boardX >= COLS || boardY >= ROWS) {
                                return true;
                            }

                            if (boardY >= 0 && board[boardY][boardX]) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            isAligned() {
                return this.x === deviceStartX && this.y === this.targetY;
            }
        }

        function startGame(mode) {
            tutorialMode = mode === "tutorial";
            tutorialStep = 0;

            if (tutorialMode) {
                document.getElementById("tutorial-message").style.display = "block";
                updateTutorial();
            } else {
                document.getElementById("tutorial-message").style.display = "none";
            }

            restartGame();

            if (!gameLoopStarted) {
                gameLoopStarted = true;
                requestAnimationFrame(gameLoop);
            }
        }

        function updateTutorial() {
            if (tutorialMode && tutorialStep < TUTORIAL_MESSAGES.length) {
                document.getElementById("tutorial-text").textContent = TUTORIAL_MESSAGES[tutorialStep];
            }
        }

        function nextTutorialStep() {
            if (tutorialMode) {
                tutorialStep++;
                if (tutorialStep >= TUTORIAL_MESSAGES.length) {
                    tutorialMode = false;
                    document.getElementById("tutorial-message").style.display = "none";
                } else {
                    updateTutorial();
                }
            }
        }

        function initBoard() {
            board = Array(ROWS)
                .fill()
                .map(() => Array(COLS).fill(0));
            currentLayerIndex = 0;
            positionDevice();
            updateDeviceBlueprint();
            updateFactBox();
            updateProgress();
        }

        function positionDevice() {
            const device = DEVICES[currentDevice];
            deviceStartX = Math.floor((COLS - device.width) / 2);
            const totalHeight = device.layers.reduce(
                (sum, layer) => sum + layer.pattern.length,
                0
            );
            deviceStartY = Math.max(0, ROWS - totalHeight - 2);
        }

        function drawBlock(x, y, color, context = ctx, size = BLOCK_SIZE) {
            const xPos = x * size;
            const yPos = y * size;

            context.fillStyle = color;
            context.fillRect(xPos + 1, yPos + 1, size - 2, size - 2);

            context.strokeStyle = "rgba(15, 23, 42, 0.18)";
            context.lineWidth = 1;
            context.strokeRect(xPos + 0.5, yPos + 0.5, size - 1, size - 1);
        }

        function draw() {
            ctx.fillStyle = "#0f172a";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = "rgba(255, 255, 255, 0.06)";
            ctx.lineWidth = 1;
            for (let i = 0; i <= COLS; i++) {
                ctx.beginPath();
                ctx.moveTo(i * BLOCK_SIZE, 0);
                ctx.lineTo(i * BLOCK_SIZE, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i <= ROWS; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * BLOCK_SIZE);
                ctx.lineTo(canvas.width, i * BLOCK_SIZE);
                ctx.stroke();
            }

            if (currentPiece && !isPaused) {
                ctx.fillStyle = "rgba(220, 226, 245, 0.2)";
                for (let row = 0; row < currentPiece.pattern.length; row++) {
                    for (let col = 0; col < currentPiece.pattern[row].length; col++) {
                        if (currentPiece.pattern[row][col]) {
                            ctx.fillRect(
                                (deviceStartX + col) * BLOCK_SIZE,
                                (currentPiece.targetY + row) * BLOCK_SIZE,
                                BLOCK_SIZE,
                                BLOCK_SIZE
                            );
                        }
                    }
                }
            }

            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    if (board[row][col]) {
                        drawBlock(col, row, board[row][col]);
                    }
                }
            }

            if (currentPiece && !isPaused) {
                for (let row = 0; row < currentPiece.pattern.length; row++) {
                    for (let col = 0; col < currentPiece.pattern[row].length; col++) {
                        if (currentPiece.pattern[row][col]) {
                            drawBlock(
                                currentPiece.x + col,
                                currentPiece.y + row,
                                currentPiece.color
                            );
                        }
                    }
                }

                if (currentPiece.isAligned()) {
                    ctx.strokeStyle = "rgba(47, 128, 237, 0.8)";
                    ctx.lineWidth = 3;
                    ctx.strokeRect(
                        currentPiece.x * BLOCK_SIZE - 2,
                        currentPiece.y * BLOCK_SIZE - 2,
                        currentPiece.pattern[0].length * BLOCK_SIZE + 4,
                        currentPiece.pattern.length * BLOCK_SIZE + 4
                    );
                }
            }
        }

        function updateDeviceBlueprint() {
            const device = DEVICES[currentDevice];

            bpCtx.fillStyle = "#f7f9ff";
            bpCtx.fillRect(0, 0, blueprintCanvas.width, blueprintCanvas.height);

            const totalRows = device.layers.reduce(
                (sum, layer) => sum + layer.pattern.length,
                0
            );
            const availableHeight = blueprintCanvas.height - 40;
            const scale = Math.max(
                18,
                Math.min(26, Math.floor(availableHeight / totalRows))
            );
            const totalHeight = totalRows * scale;
            const xOffset = (blueprintCanvas.width - device.width * scale) / 2;
            let yOffset = Math.max(16, (blueprintCanvas.height - totalHeight) / 2);

            bpCtx.font = "13px 'Inter', sans-serif";

            device.layers.forEach((layer, index) => {
                if (index === currentLayerIndex) {
                    bpCtx.fillStyle = "rgba(47, 128, 237, 0.15)";
                    bpCtx.fillRect(
                        xOffset - 12,
                        yOffset - 6,
                        device.width * scale + 24,
                        layer.pattern.length * scale + 12
                    );
                }

                layer.pattern.forEach((row, rowIndex) => {
                    row.forEach((cell, colIndex) => {
                        if (cell) {
                            drawBlock(
                                xOffset / scale + colIndex,
                                yOffset / scale + rowIndex,
                                index <= currentLayerIndex ? layer.color : "#d6deeb",
                                bpCtx,
                                scale
                            );
                        }
                    });
                });

                bpCtx.fillStyle =
                    index === currentLayerIndex ? "var(--accent)" : "rgba(31, 41, 55, 0.55)";
                bpCtx.fillText(
                    `${index + 1}. ${layer.simple}`,
                    20,
                    yOffset + (layer.pattern.length * scale) / 2 + 4
                );

                yOffset += layer.pattern.length * scale + 6;
            });

            const currentLayer = device.layers[currentLayerIndex];
            document.getElementById("current-layer").textContent = currentLayer.simple;
            document.getElementById("layer-description").textContent = currentLayer.description;
        }

        function updateFactBox() {
            document.getElementById("fact-text").textContent = FUN_FACTS[currentFactIndex];
            currentFactIndex = (currentFactIndex + 1) % FUN_FACTS.length;
        }

        function lockPiece() {
            const isPerfect = currentPiece.isAligned();

            for (let row = 0; row < currentPiece.pattern.length; row++) {
                for (let col = 0; col < currentPiece.pattern[row].length; col++) {
                    if (currentPiece.pattern[row][col]) {
                        const boardY = currentPiece.y + row;
                        const boardX = currentPiece.x + col;
                        if (boardY >= 0 && boardY < ROWS && boardX >= 0 && boardX < COLS) {
                            board[boardY][boardX] = currentPiece.color;
                        }
                    }
                }
            }

            if (isPerfect) {
                score += 500;
                showBonus("Perfect placement! +500");
                if (tutorialMode && tutorialStep === 3) {
                    nextTutorialStep();
                }
            } else {
                score += 120;
            }

            currentLayerIndex++;
            if (tutorialMode && currentLayerIndex === 1) {
                nextTutorialStep();
            }

            if (currentLayerIndex >= DEVICES[currentDevice].layers.length) {
                completeDevice();
            } else {
                updateProgress();
                spawnPiece();
            }

            updateScore();
            updateDeviceBlueprint();
        }

        function completeDevice() {
            devicesBuilt++;
            score += 2000;
            showBonus("Device complete! +2000");

            if (tutorialMode) {
                nextTutorialStep();
            }

            for (let i = 0; i < 8; i++) {
                board.pop();
                board.unshift(Array(COLS).fill(0));
            }

            currentLayerIndex = 0;
            const device = DEVICES[currentDevice];
            deviceStartX = Math.floor(Math.random() * (COLS - device.width));
            const totalHeight = device.layers.reduce(
                (sum, layer) => sum + layer.pattern.length,
                0
            );
            deviceStartY = Math.max(0, ROWS - totalHeight - 2);

            updateFactBox();
            updateProgress();
            updateScore();
            spawnPiece();
        }

        function updateProgress() {
            const device = DEVICES[currentDevice];
            const progress = (currentLayerIndex / device.layers.length) * 100;
            const progressBar = document.getElementById("progress");
            const progressText = document.getElementById("progress-text");

            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        }

        function showBonus(text) {
            const indicator = document.getElementById("bonus-indicator");
            indicator.textContent = text;
            indicator.classList.remove("bonus-active");
            requestAnimationFrame(() => indicator.classList.add("bonus-active"));
        }

        function spawnPiece() {
            currentPiece = new Piece();

            if (currentPiece.collides()) {
                gameOver();
            }
        }

        function gameOver() {
            isPaused = true;
            setTimeout(() => {
                alert(
                    `Great job! You built ${devicesBuilt} chips and scored ${score} points!\n\nYou've learned the basics of semiconductor manufacturing.`
                );
            }, 120);
        }

        function drop() {
            currentPiece.y++;
            if (currentPiece.collides()) {
                currentPiece.y--;
                lockPiece();
            }
            dropCounter = 0;
        }

        function movePiece(dir) {
            currentPiece.x += dir;
            if (currentPiece.collides()) {
                currentPiece.x -= dir;
            } else if (tutorialMode && tutorialStep === 2) {
                nextTutorialStep();
            }
        }

        function hardDrop() {
            while (!currentPiece.collides()) {
                currentPiece.y++;
            }
            currentPiece.y--;
            lockPiece();
        }

        function updateScore() {
            document.getElementById("score").textContent = score.toLocaleString();
            document.getElementById("devices").textContent = devicesBuilt;
        }

        function selectDevice(device, event) {
            currentDevice = device;
            currentLayerIndex = 0;

            document.querySelectorAll(".device-card").forEach((card) => {
                card.classList.remove("active");
            });
            if (event?.currentTarget) {
                event.currentTarget.classList.add("active");
            }

            initBoard();
            spawnPiece();
            score = 0;
            devicesBuilt = 0;
            updateScore();
        }

        function restartGame() {
            initBoard();
            score = 0;
            devicesBuilt = 0;
            isPaused = false;
            currentLayerIndex = 0;
            tutorialStep = 0;
            if (tutorialMode) {
                document.getElementById("tutorial-message").style.display = "block";
                updateTutorial();
            } else {
                document.getElementById("tutorial-message").style.display = "none";
            }
            updateScore();
            updateProgress();
            spawnPiece();
        }

        function gameLoop(time = 0) {
            if (!isPaused) {
                const deltaTime = time - lastTime;
                lastTime = time;

                dropCounter += deltaTime;
                const dropSpeed = tutorialMode ? 1200 : 850;

                if (dropCounter > dropSpeed) {
                    drop();
                }

                draw();
            }

            requestAnimationFrame(gameLoop);
        }

        document.addEventListener("keydown", (e) => {
            if (instructionsOpen) {
                if (e.key === "Escape") {
                    toggleInstructions(false);
                }
                return;
            }

            if (isPaused && e.key.toLowerCase() !== "p") return;

            switch (e.key.toLowerCase()) {
                case "arrowleft":
                    movePiece(-1);
                    break;
                case "arrowright":
                    movePiece(1);
                    break;
                case "arrowdown":
                    drop();
                    break;
                case " ":
                    e.preventDefault();
                    hardDrop();
                    break;
                case "p":
                    isPaused = !isPaused;
                    break;
            }
        });

        function toggleInstructions(show) {
            if (show) {
                instructionsModal.classList.remove("hidden");
                wasPausedBeforeModal = isPaused;
                isPaused = true;
                instructionsOpen = true;
            } else {
                instructionsModal.classList.add("hidden");
                instructionsOpen = false;
                isPaused = wasPausedBeforeModal;
            }
        }

        openInstructionsBtn.addEventListener("click", () => toggleInstructions(true));
        closeInstructionsBtn.addEventListener("click", () => toggleInstructions(false));
        resumePlayBtn.addEventListener("click", () => toggleInstructions(false));

        startGuidedBtn.addEventListener("click", () => {
            toggleInstructions(false);
            startGame("tutorial");
        });

        window.addEventListener("load", () => {
            startGame("normal");
        });
    </script>
</body>
</html>
